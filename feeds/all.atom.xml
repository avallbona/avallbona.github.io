<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom"><title>Andreu Vallbona</title><link href="https://blog.espontas.com/" rel="alternate"></link><link href="https://blog.espontas.com/feeds/all.atom.xml" rel="self"></link><id>https://blog.espontas.com/</id><updated>2018-06-03T10:41:00+02:00</updated><entry><title>Encadenar select's Html amb Django de manera fàcil i poc intrussiva</title><link href="https://blog.espontas.com/blog/chained-html-selects" rel="alternate"></link><published>2018-06-03T10:41:00+02:00</published><updated>2018-06-03T10:41:00+02:00</updated><author><name>Andreu</name></author><id>tag:blog.espontas.com,2018-06-03:/blog/chained-html-selects</id><summary type="html">&lt;p&gt;Fa un temps que he descobert un "plugin" jQuery que va força be per encadenar &lt;em&gt;select&lt;/em&gt;'s Html amb Django, és a dir, que les opcións d'un &lt;em&gt;select&lt;/em&gt; s'actualitzin en funció del valor seleccionat a un primer &lt;em&gt;select&lt;/em&gt;. El "plugin" en qüestió és diu &lt;strong&gt;&lt;a href="http://www.appelsiini.net/projects/chained" target="_blank"&gt;Chained Selects Plugin for jQuery and …&lt;/a&gt;&lt;/strong&gt;&lt;/p&gt;</summary><content type="html">&lt;p&gt;Fa un temps que he descobert un "plugin" jQuery que va força be per encadenar &lt;em&gt;select&lt;/em&gt;'s Html amb Django, és a dir, que les opcións d'un &lt;em&gt;select&lt;/em&gt; s'actualitzin en funció del valor seleccionat a un primer &lt;em&gt;select&lt;/em&gt;. El "plugin" en qüestió és diu &lt;strong&gt;&lt;a href="http://www.appelsiini.net/projects/chained" target="_blank"&gt;Chained Selects Plugin for jQuery and Zepto&lt;/a&gt;&lt;/strong&gt;. Per fer-lo servir simplement hem d'estendre el "widget" per defecte per representar els &lt;em&gt;select&lt;/em&gt;'s html en Django.&lt;!--more--&gt;&lt;/p&gt;
&lt;p&gt;La idea és crear codi html per tal que es mostri similar a la següent manera, és a dir, que la clau dels valors del primer select es fixin com a css class dels options del segon select.&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;select&lt;/span&gt; &lt;span class="na"&gt;id&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;mark&amp;quot;&lt;/span&gt; &lt;span class="na"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;mark&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
  &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;option&lt;/span&gt; &lt;span class="na"&gt;value&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;--&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;option&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
  &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;option&lt;/span&gt; &lt;span class="na"&gt;value&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;bmw&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;BMW&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;option&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
  &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;option&lt;/span&gt; &lt;span class="na"&gt;value&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;audi&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;Audi&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;option&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;select&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;select&lt;/span&gt; &lt;span class="na"&gt;id&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;series&amp;quot;&lt;/span&gt; &lt;span class="na"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;series&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
  &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;option&lt;/span&gt; &lt;span class="na"&gt;value&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;--&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;option&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
  &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;option&lt;/span&gt; &lt;span class="na"&gt;value&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;series-3&amp;quot;&lt;/span&gt; &lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;bmw&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;3 series&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;option&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
  &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;option&lt;/span&gt; &lt;span class="na"&gt;value&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;series-5&amp;quot;&lt;/span&gt; &lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;bmw&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;5 series&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;option&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
  &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;option&lt;/span&gt; &lt;span class="na"&gt;value&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;series-6&amp;quot;&lt;/span&gt; &lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;bmw&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;6 series&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;option&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
  &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;option&lt;/span&gt; &lt;span class="na"&gt;value&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;a3&amp;quot;&lt;/span&gt; &lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;audi&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;A3&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;option&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
  &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;option&lt;/span&gt; &lt;span class="na"&gt;value&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;a4&amp;quot;&lt;/span&gt; &lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;audi&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;A4&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;option&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
  &lt;span class="p"&gt;&amp;lt;&lt;/span&gt;&lt;span class="nt"&gt;option&lt;/span&gt; &lt;span class="na"&gt;value&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;a5&amp;quot;&lt;/span&gt; &lt;span class="na"&gt;class&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;audi&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;A5&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;option&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;span class="p"&gt;&amp;lt;/&lt;/span&gt;&lt;span class="nt"&gt;select&lt;/span&gt;&lt;span class="p"&gt;&amp;gt;&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Aixi doncs per fer que aixo sigui possible en Django estendrem i customitzarem el widget &lt;em&gt;Select&lt;/em&gt; que ve per defecte amb django.forms. &lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# -*- encoding: utf-8 -*-&lt;/span&gt;

&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;django.forms.widgets&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Select&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;django.utils.encoding&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;force_text&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;django.utils.html&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;format_html&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;django.utils.safestring&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;mark_safe&lt;/span&gt;


&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;CustomSelect&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Select&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;span class="sd"&gt;    Custom widget used in combination with http://www.appelsiini.net/projects/chained&lt;/span&gt;
&lt;span class="sd"&gt;    in order to have two or more related html select&amp;#39;s. Whenever the first select is changed updates&lt;/span&gt;
&lt;span class="sd"&gt;    the options of the related one&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;render_option&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;selected_choices&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;option_value&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;option_label&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;option_value&lt;/span&gt; &lt;span class="ow"&gt;is&lt;/span&gt; &lt;span class="bp"&gt;None&lt;/span&gt; &lt;span class="ow"&gt;or&lt;/span&gt; &lt;span class="n"&gt;option_value&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;option_value&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;
            &lt;span class="n"&gt;css_class&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;
        &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;css_class&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;option_value&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;option_value&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;split&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;___&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="n"&gt;option_value&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;force_text&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;option_value&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;option_value&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;selected_choices&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;selected_html&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;mark_safe&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39; selected=&amp;quot;selected&amp;quot;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;allow_multiple_selected&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="c1"&gt;# Only allow for a single selection.&lt;/span&gt;
                &lt;span class="n"&gt;selected_choices&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;remove&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;option_value&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;else&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;selected_html&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;format_html&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&amp;lt;option value=&amp;quot;{0}&amp;quot;{1} class=&amp;quot;{2}&amp;quot;&amp;gt;{3}&amp;lt;/option&amp;gt;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;option_value&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;selected_html&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                           &lt;span class="n"&gt;mark_safe&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;css_class&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;force_text&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;option_label&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Llavors el nostre formulari ha de fer ús del "widget" customitzat. En el formulari hem de parar atenció als camps "group" i "type". El camp "type" depen del valor seleccionat a "group". Per a cada valor de "group" hi ha una sèrie de valors a "type". Cada cop que el select de "group" s'actualitzi, es canvii, es recalcularan els valors de "type". Aquesta és la clau del problema, el valor de l'option del segon selector ha d'esser processat per tal d'extreure'n el propi valor de l'option així com el valor de l'element pare dins el primer selector. És per això que al mètode &lt;strong&gt;init&lt;/strong&gt; del formulari customitzam l'atribut "choices" del widget del camp "type", per passar el valor en el format:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;clau-option-select-dependent__clau-option-valor-pare&lt;/code&gt;&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;ProductFilter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;FilterFormMixin&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;django_filters&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;FilterSet&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;

    &lt;span class="n"&gt;by_name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;django_filters&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;CharFilter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;lookup_type&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;icontains&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;translations__name&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                                        &lt;span class="n"&gt;required&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;False&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;label&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Nombre&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

    &lt;span class="n"&gt;code&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;django_filters&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;CharFilter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;required&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;False&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;label&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Código&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

    &lt;span class="n"&gt;place&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;django_filters&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ModelChoiceFilter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;queryset&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;Place&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;objects&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;all&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;required&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;False&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                                             &lt;span class="n"&gt;empty_label&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Todos los recintos&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;product_places&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="n"&gt;group&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;django_filters&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ModelChoiceFilter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;queryset&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;GroupProductType&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;objects&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;all&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;required&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;False&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt;
                                             &lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;type__group&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;empty_label&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Todos los grupos&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

    &lt;span class="nb"&gt;type&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;django_filters&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;ChoiceFilter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;choices&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;required&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;False&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;label&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Todos los tipos&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

    &lt;span class="n"&gt;tags&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;NamedModelMultipleChoiceField&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;queryset&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;Tag&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;objects&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;all&lt;/span&gt;&lt;span class="p"&gt;(),&lt;/span&gt; &lt;span class="n"&gt;required&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;False&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;label&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;u&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Seleccione algún tag&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

    &lt;span class="n"&gt;ENABLED_CHOICES&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;
        &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;all&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Todos&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)),&lt;/span&gt;
        &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;si&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Activos&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)),&lt;/span&gt;
        &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;no&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Inactivos&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)),&lt;/span&gt;
    &lt;span class="p"&gt;)&lt;/span&gt;
    &lt;span class="n"&gt;enabled&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;django_filters&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;MethodFilter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;required&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;False&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;label&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Estado&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt;
                                          &lt;span class="n"&gt;action&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;filter_enabled&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;widget&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;forms&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;Select&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;choices&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;ENABLED_CHOICES&lt;/span&gt;&lt;span class="p"&gt;))&lt;/span&gt;

    &lt;span class="nd"&gt;@staticmethod&lt;/span&gt;
    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;filter_enabled&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;queryset&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;if&lt;/span&gt; &lt;span class="n"&gt;value&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;all&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;queryset&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="n"&gt;queryset&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;enabled&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;value&lt;/span&gt; &lt;span class="o"&gt;==&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;si&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Meta&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
        &lt;span class="n"&gt;model&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Product&lt;/span&gt;
        &lt;span class="n"&gt;fields&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;by_name&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;code&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;place&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;group&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;type&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;tags&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;enabled&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;queryset&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;prefix&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;strict&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;None&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;

        &lt;span class="n"&gt;choices&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;_&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="sa"&gt;u&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Todos los tipos&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;))]&lt;/span&gt;
        &lt;span class="n"&gt;choices&lt;/span&gt; &lt;span class="o"&gt;+=&lt;/span&gt; &lt;span class="p"&gt;[(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;{0}___{1}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;it&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;group_id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;it&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;pk&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;it&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt; &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;it&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;ProductType&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;objects&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;order_by&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;name&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)]&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;base_filters&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;type&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;]&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;field&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;widget&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;CustomSelect&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;choices&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;choices&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="nb"&gt;super&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="fm"&gt;__init__&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;data&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;queryset&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;prefix&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;strict&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Per gestionar l'event del canvi hem de modificar el template que renderitza el formulari. D'aquesta manera incloem el Javascript necessari, el codi del propi plugin i el codi que s'encarrega de relacionar els dos selectors. &lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="cp"&gt;{%&lt;/span&gt; &lt;span class="k"&gt;block&lt;/span&gt; &lt;span class="nv"&gt;extrajs2&lt;/span&gt; &lt;span class="cp"&gt;%}&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;script&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;text/javascript&amp;quot;&lt;/span&gt; &lt;span class="na"&gt;src=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="cp"&gt;{%&lt;/span&gt; &lt;span class="k"&gt;static&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;bower_components/chained/jquery.chained.min.js&amp;#39;&lt;/span&gt; &lt;span class="cp"&gt;%}&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&amp;lt;/script&amp;gt;&lt;/span&gt;
    &lt;span class="nt"&gt;&amp;lt;script&lt;/span&gt; &lt;span class="na"&gt;type=&lt;/span&gt;&lt;span class="s"&gt;&amp;quot;text/javascript&amp;quot;&lt;/span&gt;&lt;span class="nt"&gt;&amp;gt;&lt;/span&gt;
        $(function(){
            $(&amp;quot;#id_type&amp;quot;).chained(&amp;quot;#id_group&amp;quot;);
        });
    &lt;span class="nt"&gt;&amp;lt;/script&amp;gt;&lt;/span&gt;
&lt;span class="cp"&gt;{%&lt;/span&gt; &lt;span class="k"&gt;endblock&lt;/span&gt; &lt;span class="nv"&gt;extrajs2&lt;/span&gt; &lt;span class="cp"&gt;%}&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;A l'exemple li deim que el selector amb identificador "#id_type" depen del selector amb identificador "#id_group". Finalment senyalar que el plugin és bastant versàtil ja que permet enllaçar varis selectors a la vegada amb la mateixa tècnica. &lt;/p&gt;
&lt;p&gt;&lt;a href="http://www.appelsiini.net/projects/chained"&gt;http://www.appelsiini.net/projects/chained&lt;/a&gt;&lt;/p&gt;</content><category term="django"></category><category term="html"></category><category term="javascript"></category><category term="jquery"></category></entry><entry><title>Lookup fields customitzats en Django</title><link href="https://blog.espontas.com/blog/django-lookup-fields" rel="alternate"></link><published>2018-06-03T10:41:00+02:00</published><updated>2018-06-03T10:41:00+02:00</updated><author><name>Andreu</name></author><id>tag:blog.espontas.com,2018-06-03:/blog/django-lookup-fields</id><summary type="html">&lt;p&gt;Short version for index and feeds&lt;/p&gt;</summary><content type="html">&lt;p&gt;Django, de manera genèrica, ens proveeix una API del seu ORM a través de la qual ens permet 
executar els "&lt;a href="https://docs.djangoproject.com/en/1.9/ref/models/querysets/"&gt;querysets&lt;/a&gt;" 
que necessitem de manera més o menys optima. Malgrat això, es pot donar el cas que necessitem 
realitzar algun tipus de consulta una mica més customitzada o millorada. Per a tal efecte, 
disposem de tota una sèrie d'eines, ja siguin els 
&lt;a href="https://docs.djangoproject.com/en/1.9/ref/models/querysets/#q-objects"&gt;objectes Q&lt;/a&gt;, 
les &lt;a href="https://docs.djangoproject.com/en/1.7/ref/models/queries/#django.db.models.F"&gt;expressions F&lt;/a&gt;, 
els &lt;a href="https://docs.djangoproject.com/en/1.9/topics/db/queries/#field-lookups"&gt;Field Lookups&lt;/a&gt;, etc. 
Sobre aquest darrer grup, els &lt;strong&gt;Field lookup&lt;/strong&gt;'s tenim la possibilitat de definir 
els nostres propis.&lt;/p&gt;
&lt;p&gt;Per a implementar un "Lookup field" hem d'implementar una classe que ens permeti personalitzar 
la part esquerra i la part dreta de la clàusula sql. Es fa estenent la classe &lt;code&gt;Lookup&lt;/code&gt; 
del paquet "&lt;code&gt;django.db.models.fields.Lookup&lt;/code&gt;" i, posteriorment, registrant aquest classe 
personalitzada amb el mètode &lt;code&gt;register_lookup&lt;/code&gt; de la classe &lt;code&gt;django.db.models.fields.Field&lt;/code&gt;. 
E.g.:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;django.db.models&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Lookup&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;django.db.models.fields&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Field&lt;/span&gt;


&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Lower&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Lookup&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="sd"&gt;&amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;
&lt;span class="sd"&gt;    Custom lookup for postgres &amp;quot;lower&amp;quot; function implementation&lt;/span&gt;
&lt;span class="sd"&gt;    &amp;quot;&amp;quot;&amp;quot;&lt;/span&gt;

    &lt;span class="n"&gt;lookup_name&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;lower&amp;#39;&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;as_sql&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;qn&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;

        &lt;span class="n"&gt;lhs&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;lhs_params&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;process_lhs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;qn&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;rhs&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;rhs_params&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;process_rhs&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;qn&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;connection&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;params&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;lhs_params&lt;/span&gt; &lt;span class="o"&gt;+&lt;/span&gt; &lt;span class="n"&gt;rhs_params&lt;/span&gt;
        &lt;span class="k"&gt;return&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;lower({}) = {}&amp;#39;&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;format&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;lhs&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;rhs&lt;/span&gt;&lt;span class="p"&gt;),&lt;/span&gt; &lt;span class="n"&gt;params&lt;/span&gt;

&lt;span class="n"&gt;Field&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;register_lookup&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;Lower&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;L'exemple en concret implementa la funcionalitat de comparar el contingut d'un camp en 
minúscula amb la cadena que nosaltres li passem. Hi ha varis punts importants:&lt;/p&gt;
&lt;p&gt;&lt;code&gt;lookup_name = 'lower'&lt;/code&gt;
Defineix el nom que emprarem per executar la clàusula.&lt;/p&gt;
&lt;p&gt;&lt;code&gt;lhs, lhs_params = self.process_lhs(qn, connection)&lt;/code&gt;
Compila la part esquerra de la clàusula&lt;/p&gt;
&lt;p&gt;&lt;code&gt;rhs, rhs_params = self.process_rhs(qn, connection)&lt;/code&gt;
Compila la part dreta de la clàusula&lt;/p&gt;
&lt;p&gt;&lt;code&gt;Field.register_lookup(Lower)&lt;/code&gt;
Registrem el custom lookup per tal de poder-lo emprar.&lt;/p&gt;
&lt;p&gt;Finalment, un exemple d'ús del nostre custom lookup seria:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;task&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;TransTask&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;objects&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;object_class__lower&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;class_name&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="n"&gt;TransTask&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;DoesNotExist&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
    &lt;span class="n"&gt;task&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;None&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;&lt;code&gt;object_class__lower=class_name&lt;/code&gt;
és la part on s'aplica el "custom lookup". Compararà el contingut en minúscula del camp 
&lt;code&gt;object_class&lt;/code&gt; amb el contingut de la variable &lt;code&gt;class_name&lt;/code&gt;.&lt;/p&gt;</content><category term="django"></category><category term="queryset"></category></entry><entry><title>Afegir concurrència a comandes de Django</title><link href="https://blog.espontas.com/blog/django-concurrency" rel="alternate"></link><published>2018-06-02T10:41:00+02:00</published><updated>2018-06-02T10:41:00+02:00</updated><author><name>Andreu</name></author><id>tag:blog.espontas.com,2018-06-02:/blog/django-concurrency</id><summary type="html">&lt;p&gt;En algunes ocasions he hagut d'implementar alguna comanda de &lt;strong&gt;Django&lt;/strong&gt; 
per tal de realitzar alguna tasca de manteniment. El procés sól esser, en moltes ocasions, el mateix. Processar secuencialment un número d'objectes. El problema és que quan s'executa la comanda es sol emprar un sol procés en un sol core …&lt;/p&gt;</summary><content type="html">&lt;p&gt;En algunes ocasions he hagut d'implementar alguna comanda de &lt;strong&gt;Django&lt;/strong&gt; 
per tal de realitzar alguna tasca de manteniment. El procés sól esser, en moltes ocasions, el mateix. Processar secuencialment un número d'objectes. El problema és que quan s'executa la comanda es sol emprar un sol procés en un sol core. Això té l'inconvenient que, si el número d'objectes a tractar és molt gran, la comanda tarda considerablement.&lt;!--more--&gt;&lt;/p&gt;
&lt;p&gt;Per posar un exemple. Una comanda que processa un model simple de Django amb 340.000 registres. L'operació a executar és comptar el número de paraules d'un camp de text i desar aquest número dins un camp del propi model. Emprant l'ORM de Django no ens permet d'executar l'operació al mateix temps que es llegeix, no podem fer un "update" executant una funció Python. Per aquest motiu, hem de, primer llegir el registre, calcular el número de paraules i llavors, en un segon pas, actualitzar el número de paraules sobre cada registre. D'aquesta manera ens queda que hem d'executar una sentència "update" d'sql per a cada registre.&lt;/p&gt;
&lt;p&gt;Una possible implementació de la comanda podria esser la següent:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# -*- encoding: utf-8 -*-&lt;/span&gt;

&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;django.core.management.base&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;BaseCommand&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;...models&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;TransTask&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;...utils&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;get_num_words&lt;/span&gt;


&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Command&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;BaseCommand&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;help&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Update the number of words of the tasks&amp;quot;&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;handle&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stdout&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Reading tasks...&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="n"&gt;pairs&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[]&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;it&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;TransTask&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;objects&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;all&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
            &lt;span class="n"&gt;pairs&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;it&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;num&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;get_num_words&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;it&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;object_field_value&lt;/span&gt;&lt;span class="p"&gt;)})&lt;/span&gt;

        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;item&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;pairs&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;TransTask&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;objects&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pk&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;item&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;update&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;number_of_words&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;item&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;num&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;

        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stdout&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;end&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Emprant el suport per "&lt;strong&gt;Threads&lt;/strong&gt;" de Python 3.4, una possible solució podria esser la següent:&lt;/p&gt;
&lt;div class="highlight"&gt;&lt;pre&gt;&lt;span&gt;&lt;/span&gt;&lt;span class="c1"&gt;# -*- encoding: utf-8 -*-&lt;/span&gt;

&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;queue&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Queue&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Empty&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;threading&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;Lock&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="n"&gt;Thread&lt;/span&gt;

&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;django.core.management.base&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;BaseCommand&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;...models&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;TransTask&lt;/span&gt;
&lt;span class="kn"&gt;from&lt;/span&gt; &lt;span class="nn"&gt;...utils&lt;/span&gt; &lt;span class="kn"&gt;import&lt;/span&gt; &lt;span class="n"&gt;get_num_words&lt;/span&gt;


&lt;span class="k"&gt;class&lt;/span&gt; &lt;span class="nc"&gt;Command&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;BaseCommand&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
    &lt;span class="n"&gt;help&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="s2"&gt;&amp;quot;Update the number of words of the tasks&amp;quot;&lt;/span&gt;

    &lt;span class="n"&gt;lock&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Lock&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;queue&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Queue&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
    &lt;span class="n"&gt;num_threads&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="mi"&gt;80&lt;/span&gt;
    &lt;span class="n"&gt;threads&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="p"&gt;[]&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;handle&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;*&lt;/span&gt;&lt;span class="n"&gt;args&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="o"&gt;**&lt;/span&gt;&lt;span class="n"&gt;options&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;queue&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Queue&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stdout&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Reading tasks...&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;it&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="n"&gt;TransTask&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;objects&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;all&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;queue&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;put&lt;/span&gt;&lt;span class="p"&gt;({&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;it&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;id&lt;/span&gt;&lt;span class="p"&gt;,&lt;/span&gt; &lt;span class="s1"&gt;&amp;#39;num&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt; &lt;span class="n"&gt;get_num_words&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;it&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;object_field_value&lt;/span&gt;&lt;span class="p"&gt;)})&lt;/span&gt;

        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;i&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="nb"&gt;range&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;num_threads&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
            &lt;span class="n"&gt;t&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="n"&gt;Thread&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;target&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;worker_elements&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
            &lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;start&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
            &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;threads&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;append&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stdout&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s2"&gt;&amp;quot;Waiting for empty queue&amp;quot;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;queue&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stop_threads&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;stop_threads&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;for&lt;/span&gt; &lt;span class="n"&gt;t&lt;/span&gt; &lt;span class="ow"&gt;in&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;threads&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
            &lt;span class="n"&gt;t&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;join&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
        &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;stdout&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;write&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;Exiting main thread&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;

    &lt;span class="k"&gt;def&lt;/span&gt; &lt;span class="nf"&gt;worker_elements&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="p"&gt;):&lt;/span&gt;
        &lt;span class="k"&gt;while&lt;/span&gt; &lt;span class="ow"&gt;not&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;queue&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;empty&lt;/span&gt;&lt;span class="p"&gt;():&lt;/span&gt;
            &lt;span class="k"&gt;try&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="n"&gt;item&lt;/span&gt; &lt;span class="o"&gt;=&lt;/span&gt; &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;queue&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;get&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;timeout&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="mi"&gt;2&lt;/span&gt;&lt;span class="p"&gt;)&lt;/span&gt;
                &lt;span class="n"&gt;TransTask&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;objects&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;filter&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;pk&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;item&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;id&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;update&lt;/span&gt;&lt;span class="p"&gt;(&lt;/span&gt;&lt;span class="n"&gt;number_of_words&lt;/span&gt;&lt;span class="o"&gt;=&lt;/span&gt;&lt;span class="n"&gt;item&lt;/span&gt;&lt;span class="p"&gt;[&lt;/span&gt;&lt;span class="s1"&gt;&amp;#39;num&amp;#39;&lt;/span&gt;&lt;span class="p"&gt;])&lt;/span&gt;
            &lt;span class="k"&gt;except&lt;/span&gt; &lt;span class="n"&gt;Empty&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="k"&gt;break&lt;/span&gt;
            &lt;span class="k"&gt;finally&lt;/span&gt;&lt;span class="p"&gt;:&lt;/span&gt;
                &lt;span class="bp"&gt;self&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;queue&lt;/span&gt;&lt;span class="o"&gt;.&lt;/span&gt;&lt;span class="n"&gt;task_done&lt;/span&gt;&lt;span class="p"&gt;()&lt;/span&gt;
&lt;/pre&gt;&lt;/div&gt;


&lt;p&gt;Aquesta solució el que fá és, definir una cua ("&lt;strong&gt;Queue&lt;/strong&gt;") a la quan anem desant els elements a processar i llavors definir una sèrie de "&lt;strong&gt;Threads&lt;/strong&gt;", cadascún dels qual va desencuant els elements per tal de processar-los. D'aquesta manera aconseguim una "pseudo concurrència" a l'hora d'anar actualitzant la base de dades.&lt;/p&gt;
&lt;p&gt;Per a processar un total d'uns 340.000 registres, la primera versió va tardar uns 22 min i 55 seg. Amb la segona versió, la multithreaded, va tardar 57 seg. Executades les dues versions amb la mateixa màquina i mateixes condicions.&lt;/p&gt;
&lt;p&gt;Cal mencionar que, en realitat no estem afegint paralel.lisme, ja que només hi ha un thread executant-se a la vegada gràcies al &lt;a href="https://wiki.python.org/moin/GlobalInterpreterLock" target="_blank"&gt;GIL&lt;/a&gt; de Python. Aquest segon exemple és més ràpid ja que mentres un thread està esperant, per a mor de la connexió base de dades, s'arranca un altre thread que estigui disponible per processar un altre element.&lt;/p&gt;
&lt;p&gt;Enllaços relacionats:&lt;/p&gt;
&lt;ul&gt;
&lt;li&gt;&lt;a href="http://www.tutorialspoint.com/python/python_multithreading.htm"&gt;http://www.tutorialspoint.com/python/python_multithreading.htm&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://www.toptal.com/python/beginners-guide-to-concurrency-and-parallelism-in-python"&gt;http://www.toptal.com/python/beginners-guide-to-concurrency-and-parallelism-in-python&lt;/a&gt;&lt;/li&gt;
&lt;li&gt;&lt;a href="http://www.tutorialspoint.com/python/python_multithreading.htm"&gt;http://www.tutorialspoint.com/python/python_multithreading.htm&lt;/a&gt;&lt;/li&gt;
&lt;/ul&gt;</content><category term="django"></category><category term="concurrency"></category></entry><entry><title>Frasses</title><link href="https://blog.espontas.com/blog/429" rel="alternate"></link><published>2016-01-05T09:22:00+01:00</published><updated>2016-01-05T09:22:00+01:00</updated><author><name>blogadmin</name></author><id>tag:blog.espontas.com,2016-01-05:/blog/429</id><summary type="html">&lt;p&gt;"Most good programmers do programming not because they expect to get
paid or get adulation by the public, but because it is fun to program".
- Linus Torvalds&lt;/p&gt;</summary><content type="html">&lt;p&gt;"Most good programmers do programming not because they expect to get
paid or get adulation by the public, but because it is fun to program".
- Linus Torvalds&lt;/p&gt;</content></entry><entry><title>Detecció idioma per subdomini en Django</title><link href="https://blog.espontas.com/blog/deteccio-idioma-per-subdomini-en-django" rel="alternate"></link><published>2015-12-30T11:20:00+01:00</published><updated>2015-12-30T11:20:00+01:00</updated><author><name>blogadmin</name></author><id>tag:blog.espontas.com,2015-12-30:/blog/deteccio-idioma-per-subdomini-en-django</id><summary type="html">&lt;p&gt;Django ens proporciona eines per detectar i fixar l'idioma de la nostra
aplicació. Normalment es fa servir
&lt;strong&gt;&lt;a href="https://docs.djangoproject.com/en/1.9/topics/i18n/translation/"&gt;i18n_patterns&lt;/a&gt;&lt;/strong&gt;
a través del qual s'encapsulen les urls amb el mateix per tal que ens
fixi a l'inici del path de la url el codi d'idioma. Amb el middleware
que explicarem no cal …&lt;/p&gt;</summary><content type="html">&lt;p&gt;Django ens proporciona eines per detectar i fixar l'idioma de la nostra
aplicació. Normalment es fa servir
&lt;strong&gt;&lt;a href="https://docs.djangoproject.com/en/1.9/topics/i18n/translation/"&gt;i18n_patterns&lt;/a&gt;&lt;/strong&gt;
a través del qual s'encapsulen les urls amb el mateix per tal que ens
fixi a l'inici del path de la url el codi d'idioma. Amb el middleware
que explicarem no cal fer servir l'&lt;strong&gt;i18n_patterns&lt;/strong&gt; ja que serà el
pròpi "middleware" que detectarà i fixarà l'idioma de l'aplicació.
&lt;!--more--&gt;&lt;/p&gt;
&lt;p&gt;Primer de tot crearem l'arxiu que contindrà el "middleware":&lt;/p&gt;
&lt;p&gt;[sourcecode language="python"]&lt;/p&gt;
&lt;p&gt;# -*- encoding: utf-8 -*-&lt;/p&gt;
&lt;p&gt;from django.utils import translation&lt;br&gt;
from django.conf import settings&lt;/p&gt;
&lt;p&gt;class SubdomainLanguageMiddleware(object):&lt;br&gt;
"""&lt;br&gt;
Set the language for the site based on the subdomain the request&lt;br&gt;
is being served on. For example, serving on 'fr.domain.com' would&lt;br&gt;
make the language French (fr).&lt;br&gt;
"""&lt;br&gt;
language_codes = [it[0] for it in settings.LANGUAGES]&lt;/p&gt;
&lt;p&gt;def process_request(self, request):&lt;br&gt;
try:&lt;br&gt;
lang = request.get_host().split('.')[0]&lt;br&gt;
except IndexError:&lt;br&gt;
lang = self.language_codes[0]&lt;br&gt;
if lang == 'www':&lt;br&gt;
lang = self.language_codes[0]&lt;br&gt;
if lang and lang in self.language_codes:&lt;br&gt;
translation.activate(lang)&lt;br&gt;
request.LANGUAGE_CODE = lang&lt;/p&gt;
&lt;p&gt;[/sourcecode]&lt;/p&gt;
&lt;p&gt;Fixem-nos en el cas que no s'ens indica cap codi d'idioma i ens ve
"www", que fixem el primer idioma per defecte definit als "settings.py".&lt;/p&gt;
&lt;p&gt;Llavors, als "settings.py" hem de tenir configurats els idiomes amb els
quals volem fer feina:&lt;/p&gt;
&lt;p&gt;[sourcecode language="python"]&lt;br&gt;
LANGUAGES = (&lt;br&gt;
('ca', 'Català'),&lt;br&gt;
('es', 'Español'),&lt;br&gt;
('de', 'Deutsch'),&lt;br&gt;
('en', 'English'),&lt;br&gt;
)&lt;br&gt;
[/sourcecode]&lt;/p&gt;
&lt;p&gt;i, com a darrer pas, li hem d'indicar als "settings.py" que ens agafi el
"middleware" que acabem de crear:&lt;/p&gt;
&lt;p&gt;[sourcecode language="python"]&lt;br&gt;
MIDDLEWARE_CLASSES = (&lt;br&gt;
...,&lt;br&gt;
'myproject.language_middleware.SubdomainLanguageMiddleware',&lt;br&gt;
)&lt;br&gt;
[/sourcecode]&lt;/p&gt;
&lt;p&gt;Llavors ja podrem accedir a la web fixant l'idioma en el subdomini:&lt;/p&gt;
&lt;p&gt;[sourcecode language="html"]&lt;br&gt;
http://www.lamevaweb.com&lt;br&gt;
http://es.lamevaweb.com&lt;br&gt;
http://de.lamevaweb.com&lt;br&gt;
http://en.lamevaweb.com&lt;br&gt;
[/sourcecode]&lt;/p&gt;</content></entry><entry><title>Customització de backend d'autenticació amb Django</title><link href="https://blog.espontas.com/blog/customitzacio-de-backend-dautenticacio-amb-django" rel="alternate"></link><published>2015-12-30T10:11:00+01:00</published><updated>2015-12-30T10:11:00+01:00</updated><author><name>blogadmin</name></author><id>tag:blog.espontas.com,2015-12-30:/blog/customitzacio-de-backend-dautenticacio-amb-django</id><summary type="html">&lt;p&gt;Per defecte Django empra el backend d'autenticació "ModelBackend"&lt;/p&gt;
&lt;p&gt;[sourcecode language="python"]&lt;br&gt;
AUTHENTICATION_BACKENDS = (&lt;br&gt;
'django.contrib.auth.backends.ModelBackend',&lt;br&gt;
)&lt;br&gt;
[/sourcecode]&lt;/p&gt;
&lt;p&gt;Aquest "backend" intenta autenticara partir del nom d'usuari i la
contrasenya que reb. Nogensmenys es pot donar el cas que vulguem
autenticar a partir de l'email de l'usuari.&lt;!--more--&gt;&lt;/p&gt;
&lt;p&gt;Per aquest cas ho …&lt;/p&gt;</summary><content type="html">&lt;p&gt;Per defecte Django empra el backend d'autenticació "ModelBackend"&lt;/p&gt;
&lt;p&gt;[sourcecode language="python"]&lt;br&gt;
AUTHENTICATION_BACKENDS = (&lt;br&gt;
'django.contrib.auth.backends.ModelBackend',&lt;br&gt;
)&lt;br&gt;
[/sourcecode]&lt;/p&gt;
&lt;p&gt;Aquest "backend" intenta autenticara partir del nom d'usuari i la
contrasenya que reb. Nogensmenys es pot donar el cas que vulguem
autenticar a partir de l'email de l'usuari.&lt;!--more--&gt;&lt;/p&gt;
&lt;p&gt;Per aquest cas ho podem fer estenent la classe "ModelBackend" i
reimplementant el mètode autenticate:&lt;/p&gt;
&lt;p&gt;[sourcecode language="python"]&lt;br&gt;
class MyCustomEmailAuthBackend(ModelBackend):&lt;br&gt;
"""&lt;br&gt;
Allow users to log in with their email address&lt;br&gt;
"""&lt;/p&gt;
&lt;p&gt;def authenticate(self, email=None, password=None, **kwargs):&lt;/p&gt;
&lt;p&gt;if email is None or password is None:&lt;br&gt;
return None&lt;/p&gt;
&lt;p&gt;try:&lt;br&gt;
user = User.objects.get(email=email)&lt;br&gt;
if user.check_password(password):&lt;br&gt;
return user&lt;br&gt;
except User.DoesNotExist:&lt;br&gt;
return None&lt;br&gt;
[/sourcecode]&lt;/p&gt;
&lt;p&gt;Un cop que tenim el backend implementat l'hem d'afegir als "settings"
per tal que Django ho tingui en compte:&lt;/p&gt;
&lt;p&gt;[sourcecode language="python"]&lt;br&gt;
AUTHENTICATION_BACKENDS = (&lt;br&gt;
'authentication.MyCustomEmailAuthBackend',&lt;br&gt;
'django.contrib.auth.backends.ModelBackend',&lt;br&gt;
)&lt;br&gt;
[/sourcecode]&lt;br&gt;
Aleshores si el nostre formulari posteja l'email i la contrasenya ja ens
podrem autenticar.&lt;/p&gt;</content></entry><entry><title>Formateig per defecte de les dates amb Django</title><link href="https://blog.espontas.com/blog/formateig-per-defecte-de-les-dates-amb-django" rel="alternate"></link><published>2015-09-13T21:32:00+02:00</published><updated>2015-09-13T21:32:00+02:00</updated><author><name>blogadmin</name></author><id>tag:blog.espontas.com,2015-09-13:/blog/formateig-per-defecte-de-les-dates-amb-django</id><summary type="html">&lt;p&gt;Al principi de començar amb &lt;strong&gt;Django&lt;/strong&gt; me vaig trobar amb el problema
del format de les dates. Per a la part de frontend no és massa
problemàtic ja que podem fixar noltros el format de cada data en
particular. Per exemple:&lt;br&gt;
[sourcecode language="python"]&lt;br&gt;
&amp;lt;p&amp;gt;{% trans 'Fecha salida' %}: {{
reservation.departure_date_res …&lt;/p&gt;</summary><content type="html">&lt;p&gt;Al principi de començar amb &lt;strong&gt;Django&lt;/strong&gt; me vaig trobar amb el problema
del format de les dates. Per a la part de frontend no és massa
problemàtic ja que podem fixar noltros el format de cada data en
particular. Per exemple:&lt;br&gt;
[sourcecode language="python"]&lt;br&gt;
&amp;lt;p&amp;gt;{% trans 'Fecha salida' %}: {{
reservation.departure_date_res|date:'d/m/Y' }}&amp;lt;/p&amp;gt;&lt;br&gt;
[/sourcecode]&lt;br&gt;
El problema sorgeix amb, per exemple, el format de les dates de
l'administrador, el qual està determinat pels valors per defecte de
django. &lt;!--more--&gt;&lt;/p&gt;
&lt;p&gt;Aquests solen variar en funció de l'idioma de l'usuari i/o del
navegador. Per corregir aquests fet, &lt;strong&gt;Django&lt;/strong&gt; ens proporciona un
mètode per poder fixar els formats per defecte de les dates. Al
directori on està definit el projecte s'ha de creat una carpeta
"formats" que contingui un directori per a cada idioma (es, ca, de, en,
...) i que, cadascuna d'aquestes contingui un arxiu "formats.py" amb els
formats de les dates. Per exemple:&lt;br&gt;
&lt;a href="http://www.espontas.com/wp-content/uploads/captura-date-formats.png"&gt;&lt;img alt="captura date
formats" src="http://www.espontas.com/wp-content/uploads/captura-date-formats.png"&gt;{.alignleft
.size-full .wp-image-378 width="861"
height="462"}&lt;/a&gt;&lt;br&gt;
Llavors al settings.py s'ha d'afegir una linia per indicar d'on s'ha
d'agafar el format de les dates:&lt;/p&gt;
&lt;p&gt;[sourcecode language="python"]&lt;br&gt;
FORMAT_MODULE_PATH = 'balearictransfer.formats'&lt;br&gt;
[/sourcecode]&lt;/p&gt;
&lt;p&gt;També es poden indicar el format de les dates pels "inputs" de les
dates, així com el separador decimal o de mils, per exemple:&lt;/p&gt;
&lt;p&gt;[sourcecode language="python"]&lt;br&gt;
DATE_INPUT_FORMATS = (&lt;br&gt;
'%d-%m-%Y', # '21-03-2014'&lt;br&gt;
)&lt;br&gt;
TIME_INPUT_FORMATS = (&lt;br&gt;
'%H:%M:%S', # '17:59:59'&lt;br&gt;
'%H:%M', # '17:59'&lt;br&gt;
)&lt;br&gt;
DATETIME_INPUT_FORMATS = (&lt;br&gt;
'%d-%m-%Y %H:%M', # '21-03-2014 17:59'&lt;br&gt;
)&lt;/p&gt;
&lt;p&gt;DECIMAL_SEPARATOR = u'.'&lt;br&gt;
THOUSAND_SEPARATOR = u','&lt;br&gt;
NUMBER_GROUPING = 3&lt;br&gt;
[/sourcecode]&lt;/p&gt;
&lt;p&gt;A &lt;strong&gt;Github&lt;/strong&gt; podeu trobar un &lt;a href="https://github.com/andilabs/demo_time_set"&gt;projecte de
mostra&lt;/a&gt; que explica com
funciona el tema. I també la &lt;a href="http://stackoverflow.com/a/22565251"&gt;pertinent
explicació&lt;/a&gt; a &lt;strong&gt;Stack Overflow&lt;/strong&gt;&lt;/p&gt;</content><category term="date format"></category><category term="django"></category><category term="strftime"></category></entry><entry><title>About development</title><link href="https://blog.espontas.com/blog/368" rel="alternate"></link><published>2015-09-13T12:27:00+02:00</published><updated>2015-09-13T12:27:00+02:00</updated><author><name>blogadmin</name></author><id>tag:blog.espontas.com,2015-09-13:/blog/368</id><summary type="html">&lt;blockquote&gt;
&lt;p&gt;"Top notch development teams don't torture their programmers. Even
minor frustrations caused by using underpowered tools add up, making
programmers grumpy and unhappy. And a grumpy programmer is an
unproductive programmer." - Joel Spolsky, from the "&lt;a href="http://www.joelonsoftware.com/articles/fog0000000043.html"&gt;Joel
Test&lt;/a&gt;".&lt;/p&gt;
&lt;/blockquote&gt;</summary><content type="html">&lt;blockquote&gt;
&lt;p&gt;"Top notch development teams don't torture their programmers. Even
minor frustrations caused by using underpowered tools add up, making
programmers grumpy and unhappy. And a grumpy programmer is an
unproductive programmer." - Joel Spolsky, from the "&lt;a href="http://www.joelonsoftware.com/articles/fog0000000043.html"&gt;Joel
Test&lt;/a&gt;".&lt;/p&gt;
&lt;/blockquote&gt;</content></entry><entry><title>Django extra views</title><link href="https://blog.espontas.com/blog/django-extra-views" rel="alternate"></link><published>2015-09-12T20:56:00+02:00</published><updated>2015-09-12T20:56:00+02:00</updated><author><name>blogadmin</name></author><id>tag:blog.espontas.com,2015-09-12:/blog/django-extra-views</id><summary type="html">&lt;p&gt;"&lt;strong&gt;&lt;a href="https://github.com/AndrewIngram/django-extra-views"&gt;Django extra
views&lt;/a&gt;&lt;/strong&gt;" ens
proporciona una manera fàcil, a través de les seves vistes
"vitaminades", d'implementar els
"&lt;strong&gt;&lt;a href="https://docs.djangoproject.com/en/1.8/topics/forms/formsets/"&gt;formsets&lt;/a&gt;&lt;/strong&gt;"
per tal d'editar les relacions 1-n amb Django. Tambe tenir
&lt;strong&gt;&lt;a href="https://github.com/pretix/django-formset-js"&gt;django-formset-js&lt;/a&gt;&lt;/strong&gt; que
ens "dinamitza" a través de Javascript la inserció i eliminació de
tuples dels&lt;strong&gt; "formsets"&lt;/strong&gt;.&lt;!--more--&gt;&lt;/p&gt;
&lt;p&gt;Per instal.lar les "django extra …&lt;/p&gt;</summary><content type="html">&lt;p&gt;"&lt;strong&gt;&lt;a href="https://github.com/AndrewIngram/django-extra-views"&gt;Django extra
views&lt;/a&gt;&lt;/strong&gt;" ens
proporciona una manera fàcil, a través de les seves vistes
"vitaminades", d'implementar els
"&lt;strong&gt;&lt;a href="https://docs.djangoproject.com/en/1.8/topics/forms/formsets/"&gt;formsets&lt;/a&gt;&lt;/strong&gt;"
per tal d'editar les relacions 1-n amb Django. Tambe tenir
&lt;strong&gt;&lt;a href="https://github.com/pretix/django-formset-js"&gt;django-formset-js&lt;/a&gt;&lt;/strong&gt; que
ens "dinamitza" a través de Javascript la inserció i eliminació de
tuples dels&lt;strong&gt; "formsets"&lt;/strong&gt;.&lt;!--more--&gt;&lt;/p&gt;
&lt;p&gt;Per instal.lar les "django extra views" cal executar:&lt;/p&gt;
&lt;p&gt;[sourcecode language="bash" wraplines="false" collapse="false"]&lt;br&gt;
pip install django-extra-views&lt;br&gt;
[/sourcecode]&lt;/p&gt;
&lt;p&gt;Per instal.lar django-formset-js cal executar:&lt;br&gt;
[sourcecode language="bash" wraplines="false" collapse="false"]&lt;br&gt;
pip install django-formset-js&lt;br&gt;
[/sourcecode]&lt;br&gt;
i afegir l'aplicació al projecte:&lt;br&gt;
[sourcecode language="python" wraplines="false" collapse="false"]&lt;br&gt;
INSTALLED_APPS = (&lt;br&gt;
...&lt;br&gt;
'djangoformsetjs',&lt;br&gt;
)&lt;br&gt;
[/sourcecode]&lt;/p&gt;
&lt;p&gt;Detallant els passos, que serien:&lt;br&gt;
&lt;strong&gt;Views&lt;/strong&gt;:&lt;/p&gt;
&lt;p&gt;[sourcecode language="python" wraplines="false" collapse="false"]&lt;br&gt;
# -*- encoding: utf-8 -*-&lt;/p&gt;
&lt;p&gt;from crispy_forms.helper import FormHelper&lt;br&gt;
from crispy_forms.layout import Layout&lt;br&gt;
from crispy_forms.layout import Div&lt;/p&gt;
&lt;p&gt;from django import forms&lt;/p&gt;
&lt;p&gt;from extra_views import CreateWithInlinesView, UpdateWithInlinesView,
InlineFormSet&lt;br&gt;
from backoffice.cars.models import AssuranceFeaturePrice,
EquipmentPrice, ChargePrice&lt;br&gt;
from cms.cmscars.office.forms import AssuranceFeaturePriceForm,
EquipmentPriceForm, ChargePriceForm&lt;/p&gt;
&lt;p&gt;#########&lt;br&gt;
# views #&lt;br&gt;
#########&lt;/p&gt;
&lt;p&gt;class AssuranceFeaturePricesInline(InlineFormSet):&lt;br&gt;
model = AssuranceFeaturePrice&lt;br&gt;
form_class = AssuranceFeaturePriceForm&lt;br&gt;
extra = 0&lt;/p&gt;
&lt;p&gt;class EquipmentPricesInline(InlineFormSet):&lt;br&gt;
model = EquipmentPrice&lt;br&gt;
form_class = EquipmentPriceForm&lt;br&gt;
extra = 0&lt;/p&gt;
&lt;p&gt;class ChargePricesInline(InlineFormSet):&lt;br&gt;
model = ChargePrice&lt;br&gt;
form_class = ChargePriceForm&lt;br&gt;
extra = 0&lt;/p&gt;
&lt;p&gt;class OfficeCreateView(CreateWithInlinesView):&lt;br&gt;
inlines = [AssuranceFeaturePricesInline, EquipmentPricesInline,
ChargePricesInline]&lt;br&gt;
pass&lt;/p&gt;
&lt;p&gt;class OfficeUpdateView(UpdateWithInlinesView):&lt;br&gt;
inlines = [AssuranceFeaturePricesInline, EquipmentPricesInline,
ChargePricesInline]&lt;br&gt;
pass&lt;br&gt;
[/sourcecode]&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Forms&lt;/strong&gt;:&lt;/p&gt;
&lt;p&gt;[sourcecode language="python" wraplines="false" collapse="false"]&lt;br&gt;
class AssuranceFeaturePriceForm(forms.ModelForm):&lt;/p&gt;
&lt;p&gt;class Meta:&lt;br&gt;
model = AssuranceFeaturePrice&lt;br&gt;
fields = ('id', 'office', 'feature', 'price')&lt;/p&gt;
&lt;p&gt;@property&lt;br&gt;
def helper(self):&lt;br&gt;
helper = FormHelper()&lt;br&gt;
helper.label_class = 'col-xs-4'&lt;br&gt;
helper.field_class = 'col-xs-6'&lt;br&gt;
helper.form_tag = False&lt;br&gt;
helper.layout = Layout(&lt;br&gt;
'id', 'office', 'feature', 'price',&lt;br&gt;
Div('DELETE', css_class='hidden')&lt;br&gt;
)&lt;br&gt;
return helper&lt;/p&gt;
&lt;p&gt;class EquipmentPriceForm(forms.ModelForm):&lt;/p&gt;
&lt;p&gt;class Meta:&lt;br&gt;
model = EquipmentPrice&lt;br&gt;
fields = ('id', 'office', 'equipment', 'price')&lt;/p&gt;
&lt;p&gt;@property&lt;br&gt;
def helper(self):&lt;br&gt;
helper = FormHelper()&lt;br&gt;
helper.label_class = 'col-xs-4'&lt;br&gt;
helper.field_class = 'col-xs-6'&lt;br&gt;
helper.form_tag = False&lt;br&gt;
helper.layout = Layout(&lt;br&gt;
'id', 'office', 'equipment', 'price',&lt;br&gt;
Div('DELETE', css_class='hidden')&lt;br&gt;
)&lt;br&gt;
return helper&lt;/p&gt;
&lt;p&gt;class ChargePriceForm(forms.ModelForm):&lt;/p&gt;
&lt;p&gt;class Meta:&lt;br&gt;
model = ChargePrice&lt;br&gt;
fields = ('id', 'office', 'charge', 'price')&lt;/p&gt;
&lt;p&gt;@property&lt;br&gt;
def helper(self):&lt;br&gt;
helper = FormHelper()&lt;br&gt;
helper.label_class = 'col-xs-4'&lt;br&gt;
helper.field_class = 'col-xs-6'&lt;br&gt;
helper.form_tag = False&lt;br&gt;
helper.layout = Layout(&lt;br&gt;
'id', 'office', 'charge', 'price',&lt;br&gt;
Div('DELETE', css_class='hidden')&lt;br&gt;
)&lt;br&gt;
return helper&lt;/p&gt;
&lt;p&gt;[/sourcecode]&lt;/p&gt;
&lt;p&gt;&lt;strong&gt;Template&lt;/strong&gt;:&lt;/p&gt;
&lt;p&gt;[sourcecode language="python" wraplines="false" collapse="false"]&lt;br&gt;
############&lt;br&gt;
# template #&lt;br&gt;
############&lt;/p&gt;
&lt;p&gt;{% block content2 %}&lt;br&gt;
{{ form.media }}&lt;/p&gt;
&lt;p&gt;&amp;lt;form id="form-office" method="post" action="{% if object %}{% url
update_url smydestination object.pk %}{% else %}{% url create_url
smydestination %}{% endif %}" class="form-horizontal"&amp;gt;&lt;br&gt;
{{ form.errors }}&lt;br&gt;
{% crispy form %}&lt;br&gt;
&amp;lt;!-- formsets --&amp;gt;&lt;/p&gt;
&lt;p _="%" for formset in inlines&gt;&amp;lt;div id="initial-precios" class="x_panel col-md-offset-2
col-md-7"&amp;gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;&amp;lt;div id="container-{{ formset.prefix }}"&amp;gt;&lt;/p&gt;
&lt;p&gt;&amp;lt;div class="x_title"&amp;gt;&lt;/p&gt;
&lt;p&gt;&amp;lt;h4&amp;gt;{% show_formset_name formset %}&amp;lt;/h4&amp;gt;&lt;/p&gt;
&lt;p&gt;&amp;lt;/div&amp;gt;&lt;/p&gt;
&lt;p&gt;&amp;lt;div class="formset well" data-formset-prefix="{{ formset.prefix
}}"&amp;gt;&lt;/p&gt;
&lt;p&gt;&amp;lt;div class="errors"&amp;gt;{{ formset.non_form_errors }}&amp;lt;/div&amp;gt;&lt;/p&gt;
&lt;p&gt;{{ formset.management_form }}&lt;/p&gt;
&lt;p _="%" for formset in item&gt;&amp;lt;div data-formset-body&amp;gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;&amp;lt;div class="formset_item form-inline" data-formset-form&amp;gt;&lt;br&gt;
{% crispy item %}&lt;br&gt;
&amp;lt;button type="button" data-formset-delete-button class="btn
btn-danger pull-right"&amp;gt;&amp;lt;i class="fa fa-trash"&amp;gt;&amp;lt;/i&amp;gt; {%
trans 'Borrar' %}&amp;lt;/button&amp;gt;&lt;br&gt;
&amp;lt;/div&amp;gt;&lt;/p&gt;
&lt;p&gt;{% endfor %}&lt;br&gt;
&amp;lt;/div&amp;gt;&lt;/p&gt;
&lt;p _="%" escapescript&gt;&amp;lt;script type="form-template" data-formset-empty-form&amp;gt;&lt;br&gt;&lt;/p&gt;
&lt;p&gt;&amp;lt;div class="formset_item form-inline" data-formset-form&amp;gt;&lt;br&gt;
{% crispy formset.empty_form %}&lt;br&gt;
&amp;lt;button type="button" data-formset-delete-button class="btn
btn-danger pull-right"&amp;gt;&amp;lt;i class="fa fa-trash"&amp;gt;&amp;lt;/i&amp;gt; {%
trans 'Borrar' %}&amp;lt;/button&amp;gt;&lt;br&gt;
&amp;lt;/div&amp;gt;&lt;/p&gt;
&lt;p&gt;{% endescapescript %}&lt;br&gt;
&amp;lt;/script&amp;gt;&lt;br&gt;
&amp;lt;a class="btn btn-success" data-formset-add&amp;gt;&lt;br&gt;
&amp;lt;i class="fa fa-plus-square-o"&amp;gt;&amp;lt;/i&amp;gt; {% trans 'Añadir
registro' %}&lt;br&gt;
&amp;lt;/a&amp;gt;&lt;br&gt;
&amp;lt;/div&amp;gt;&lt;/p&gt;
&lt;p&gt;&amp;lt;/div&amp;gt;&lt;/p&gt;
&lt;p&gt;{% endfor %}&lt;br&gt;
&amp;lt;/div&amp;gt;&lt;/p&gt;
&lt;p&gt;&amp;lt;!-- fin formsets --&amp;gt;&lt;br&gt;
&amp;lt;/form&amp;gt;&lt;/p&gt;
&lt;p&gt;{% endblock content2 %}&lt;/p&gt;
&lt;p&gt;{% block extrajs %}&lt;br&gt;
&amp;lt;script type="text/javascript" src="{% static
'js/jquery.formset.min.js' %}"&amp;gt;&amp;lt;/script&amp;gt;&lt;br&gt;
&amp;lt;script type="text/javascript"&amp;gt;&lt;br&gt;
//&amp;lt;![CDATA[ \$(function(\$) { \$(".formset").formset({
animateForms: true, reorderMode: 'none', }); }); //]]&amp;gt;&lt;br&gt;
&amp;lt;/script&amp;gt;&lt;br&gt;
{% endblock %}&lt;br&gt;
[/sourcecode]&lt;/p&gt;
&lt;p&gt;A aquest exemple també es fa ús de &lt;a href="http://django-crispy-forms.readthedocs.org/en/latest/"&gt;Crispy
Forms&lt;/a&gt;, per tal
de millorar l'aparença dels formularis. Per instal.lar-ho:&lt;/p&gt;
&lt;p&gt;[sourcecode language="python" wraplines="false" collapse="false"]&lt;br&gt;
pip install --upgrade django-crispy-forms&lt;br&gt;
[/sourcecode]&lt;br&gt;
i afegir l'aplicació al projecte:&lt;br&gt;
[sourcecode language="python" wraplines="false" collapse="false"]&lt;br&gt;
INSTALLED_APPS = (&lt;br&gt;
...&lt;br&gt;
'crispy_forms',&lt;br&gt;
)&lt;br&gt;
[/sourcecode]&lt;/p&gt;
&lt;p&gt;En aquest cas hi ha varis "formsets" relacionats amb el model principal.
Per qüestió d'usabilitat s'ha implementat el formset dins un "Tab" del
formulari principal. L'exemple exposat queda segons es mostra a
l'imatge.&lt;/p&gt;
&lt;p&gt;&lt;a href="http://www.espontas.com/wp-content/uploads/captura_formsets_cropped.png"&gt;&lt;img alt="captura_formsets_cropped" src="http://www.espontas.com/wp-content/uploads/captura_formsets_cropped-1024x699.png"&gt;{.alignleft
.size-large .wp-image-344 width="660"
height="451"}&lt;/a&gt;&lt;/p&gt;
&lt;p&gt;Per aprofondir en els paquets citats a l'exemple es recomana visitar els
enllaços als mateixos.&lt;/p&gt;</content><category term="django extra viwws"></category><category term="django formset js"></category><category term="formset"></category></entry></feed>