<!DOCTYPE html>
<html lang="en">
<head>
        <meta charset="utf-8" />
        <title>Andreu Vallbona - javascript</title>
        <link rel="stylesheet" href="https:/www.espontas.com/theme/css/main.css" />
        <link href="https:/www.espontas.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate" title="Andreu Vallbona Atom Feed" />

        <!--[if IE]>
            <script src="https://html5shiv.googlecode.com/svn/trunk/html5.js"></script>
        <![endif]-->
</head>

<body id="index" class="home">
        <header id="banner" class="body">
                <h1><a href="https:/www.espontas.com/">Andreu Vallbona </a></h1>
                <nav><ul>
                    <li><a href="https:/www.espontas.com/pages/about-me.html">About me</a></li>
                    <li><a href="https:/www.espontas.com/category/django.html">Django</a></li>
                </ul></nav>
        </header><!-- /#banner -->

            <aside id="featured" class="body">
                <article>
                    <h1 class="entry-title"><a href="https:/www.espontas.com/chained-html-selects.html">Encadenar select's Html amb Django de manera fàcil i poc intrussiva</a></h1>
<footer class="post-info">
        <abbr class="published" title="2018-06-03T10:41:00+02:00">
                Published: dom 03 junio 2018
        </abbr>
		<br />
        <abbr class="modified" title="2018-06-03T10:41:00+02:00">
                Updated: dom 03 junio 2018
        </abbr>

        <address class="vcard author">
                By                         <a class="url fn" href="https:/www.espontas.com/author/andreu.html">Andreu</a>
        </address>
<p>In <a href="https:/www.espontas.com/category/django.html">Django</a>.</p>
<p>tags: <a href="https:/www.espontas.com/tag/django.html">django</a> <a href="https:/www.espontas.com/tag/html.html">html</a> <a href="https:/www.espontas.com/tag/javascript.html">javascript</a> <a href="https:/www.espontas.com/tag/jquery.html">jquery</a> </p>
</footer><!-- /.post-info --><p>Fa un temps que he descobert un "plugin" jQuery que va força be per encadenar <em>select</em>'s Html amb Django, és a dir, que les opcións d'un <em>select</em> s'actualitzin en funció del valor seleccionat a un primer <em>select</em>. El "plugin" en qüestió és diu <strong><a href="http://www.appelsiini.net/projects/chained" target="_blank">Chained Selects Plugin for jQuery and Zepto</a></strong>. Per fer-lo servir simplement hem d'estendre el "widget" per defecte per representar els <em>select</em>'s html en Django.<!--more--></p>
<p>La idea és crear codi html per tal que es mostri similar a la següent manera, és a dir, que la clau dels valors del primer select es fixin com a css class dels options del segon select.</p>
<div class="highlight"><pre><span></span><span class="p">&lt;</span><span class="nt">select</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;mark&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;mark&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">&gt;</span>--<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;bmw&quot;</span><span class="p">&gt;</span>BMW<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;audi&quot;</span><span class="p">&gt;</span>Audi<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
<span class="p">&lt;</span><span class="nt">select</span> <span class="na">id</span><span class="o">=</span><span class="s">&quot;series&quot;</span> <span class="na">name</span><span class="o">=</span><span class="s">&quot;series&quot;</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;&quot;</span><span class="p">&gt;</span>--<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;series-3&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;bmw&quot;</span><span class="p">&gt;</span>3 series<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;series-5&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;bmw&quot;</span><span class="p">&gt;</span>5 series<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;series-6&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;bmw&quot;</span><span class="p">&gt;</span>6 series<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;a3&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;audi&quot;</span><span class="p">&gt;</span>A3<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;a4&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;audi&quot;</span><span class="p">&gt;</span>A4<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
  <span class="p">&lt;</span><span class="nt">option</span> <span class="na">value</span><span class="o">=</span><span class="s">&quot;a5&quot;</span> <span class="na">class</span><span class="o">=</span><span class="s">&quot;audi&quot;</span><span class="p">&gt;</span>A5<span class="p">&lt;/</span><span class="nt">option</span><span class="p">&gt;</span>
<span class="p">&lt;/</span><span class="nt">select</span><span class="p">&gt;</span>
</pre></div>


<p>Aixi doncs per fer que aixo sigui possible en Django estendrem i customitzarem el widget <em>Select</em> que ve per defecte amb django.forms. </p>
<div class="highlight"><pre><span></span><span class="c1"># -*- encoding: utf-8 -*-</span>

<span class="kn">from</span> <span class="nn">django.forms.widgets</span> <span class="kn">import</span> <span class="n">Select</span>
<span class="kn">from</span> <span class="nn">django.utils.encoding</span> <span class="kn">import</span> <span class="n">force_text</span>
<span class="kn">from</span> <span class="nn">django.utils.html</span> <span class="kn">import</span> <span class="n">format_html</span>
<span class="kn">from</span> <span class="nn">django.utils.safestring</span> <span class="kn">import</span> <span class="n">mark_safe</span>


<span class="k">class</span> <span class="nc">CustomSelect</span><span class="p">(</span><span class="n">Select</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Custom widget used in combination with http://www.appelsiini.net/projects/chained</span>
<span class="sd">    in order to have two or more related html select&#39;s. Whenever the first select is changed updates</span>
<span class="sd">    the options of the related one</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">render_option</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">selected_choices</span><span class="p">,</span> <span class="n">option_value</span><span class="p">,</span> <span class="n">option_label</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">option_value</span> <span class="ow">is</span> <span class="bp">None</span> <span class="ow">or</span> <span class="n">option_value</span> <span class="o">==</span> <span class="s1">&#39;&#39;</span><span class="p">:</span>
            <span class="n">option_value</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
            <span class="n">css_class</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">css_class</span><span class="p">,</span> <span class="n">option_value</span> <span class="o">=</span> <span class="n">option_value</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;___&#39;</span><span class="p">)</span>

        <span class="n">option_value</span> <span class="o">=</span> <span class="n">force_text</span><span class="p">(</span><span class="n">option_value</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">option_value</span> <span class="ow">in</span> <span class="n">selected_choices</span><span class="p">:</span>
            <span class="n">selected_html</span> <span class="o">=</span> <span class="n">mark_safe</span><span class="p">(</span><span class="s1">&#39; selected=&quot;selected&quot;&#39;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">allow_multiple_selected</span><span class="p">:</span>
                <span class="c1"># Only allow for a single selection.</span>
                <span class="n">selected_choices</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">option_value</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">selected_html</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span>
        <span class="k">return</span> <span class="n">format_html</span><span class="p">(</span><span class="s1">&#39;&lt;option value=&quot;{0}&quot;{1} class=&quot;{2}&quot;&gt;{3}&lt;/option&gt;&#39;</span><span class="p">,</span> <span class="n">option_value</span><span class="p">,</span> <span class="n">selected_html</span><span class="p">,</span>
                           <span class="n">mark_safe</span><span class="p">(</span><span class="n">css_class</span><span class="p">),</span> <span class="n">force_text</span><span class="p">(</span><span class="n">option_label</span><span class="p">))</span>
</pre></div>


<p>Llavors el nostre formulari ha de fer ús del "widget" customitzat. En el formulari hem de parar atenció als camps "group" i "type". El camp "type" depen del valor seleccionat a "group". Per a cada valor de "group" hi ha una sèrie de valors a "type". Cada cop que el select de "group" s'actualitzi, es canvii, es recalcularan els valors de "type". Aquesta és la clau del problema, el valor de l'option del segon selector ha d'esser processat per tal d'extreure'n el propi valor de l'option així com el valor de l'element pare dins el primer selector. És per això que al mètode <strong>init</strong> del formulari customitzam l'atribut "choices" del widget del camp "type", per passar el valor en el format:</p>
<p><code>clau-option-select-dependent__clau-option-valor-pare</code></p>
<div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ProductFilter</span><span class="p">(</span><span class="n">FilterFormMixin</span><span class="p">,</span> <span class="n">django_filters</span><span class="o">.</span><span class="n">FilterSet</span><span class="p">):</span>

    <span class="n">by_name</span> <span class="o">=</span> <span class="n">django_filters</span><span class="o">.</span><span class="n">CharFilter</span><span class="p">(</span><span class="n">lookup_type</span><span class="o">=</span><span class="s1">&#39;icontains&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;translations__name&#39;</span><span class="p">,</span>
                                        <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Nombre&#39;</span><span class="p">))</span>

    <span class="n">code</span> <span class="o">=</span> <span class="n">django_filters</span><span class="o">.</span><span class="n">CharFilter</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Código&#39;</span><span class="p">))</span>

    <span class="n">place</span> <span class="o">=</span> <span class="n">django_filters</span><span class="o">.</span><span class="n">ModelChoiceFilter</span><span class="p">(</span><span class="n">queryset</span><span class="o">=</span><span class="n">Place</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                             <span class="n">empty_label</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Todos los recintos&#39;</span><span class="p">),</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;product_places&#39;</span><span class="p">)</span>

    <span class="n">group</span> <span class="o">=</span> <span class="n">django_filters</span><span class="o">.</span><span class="n">ModelChoiceFilter</span><span class="p">(</span><span class="n">queryset</span><span class="o">=</span><span class="n">GroupProductType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                                             <span class="n">name</span><span class="o">=</span><span class="s1">&#39;type__group&#39;</span><span class="p">,</span> <span class="n">empty_label</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Todos los grupos&#39;</span><span class="p">))</span>

    <span class="nb">type</span> <span class="o">=</span> <span class="n">django_filters</span><span class="o">.</span><span class="n">ChoiceFilter</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="p">(),</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Todos los tipos&#39;</span><span class="p">))</span>

    <span class="n">tags</span> <span class="o">=</span> <span class="n">NamedModelMultipleChoiceField</span><span class="p">(</span><span class="n">queryset</span><span class="o">=</span><span class="n">Tag</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">all</span><span class="p">(),</span> <span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Seleccione algún tag&#39;</span><span class="p">))</span>

    <span class="n">ENABLED_CHOICES</span> <span class="o">=</span> <span class="p">(</span>
        <span class="p">(</span><span class="s1">&#39;all&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Todos&#39;</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;si&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Activos&#39;</span><span class="p">)),</span>
        <span class="p">(</span><span class="s1">&#39;no&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="s1">&#39;Inactivos&#39;</span><span class="p">)),</span>
    <span class="p">)</span>
    <span class="n">enabled</span> <span class="o">=</span> <span class="n">django_filters</span><span class="o">.</span><span class="n">MethodFilter</span><span class="p">(</span><span class="n">required</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">_</span><span class="p">(</span><span class="s1">&#39;Estado&#39;</span><span class="p">),</span>
                                          <span class="n">action</span><span class="o">=</span><span class="s1">&#39;filter_enabled&#39;</span><span class="p">,</span> <span class="n">widget</span><span class="o">=</span><span class="n">forms</span><span class="o">.</span><span class="n">Select</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">ENABLED_CHOICES</span><span class="p">))</span>

    <span class="nd">@staticmethod</span>
    <span class="k">def</span> <span class="nf">filter_enabled</span><span class="p">(</span><span class="n">queryset</span><span class="p">,</span> <span class="n">value</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;all&#39;</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">queryset</span>
        <span class="k">return</span> <span class="n">queryset</span><span class="o">.</span><span class="n">filter</span><span class="p">(</span><span class="n">enabled</span><span class="o">=</span><span class="n">value</span> <span class="o">==</span> <span class="s1">&#39;si&#39;</span><span class="p">)</span>

    <span class="k">class</span> <span class="nc">Meta</span><span class="p">:</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">Product</span>
        <span class="n">fields</span> <span class="o">=</span> <span class="p">(</span><span class="s1">&#39;by_name&#39;</span><span class="p">,</span> <span class="s1">&#39;code&#39;</span><span class="p">,</span> <span class="s1">&#39;place&#39;</span><span class="p">,</span> <span class="s1">&#39;group&#39;</span><span class="p">,</span> <span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;tags&#39;</span><span class="p">,</span> <span class="s1">&#39;enabled&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">queryset</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="bp">None</span><span class="p">,</span> <span class="n">strict</span><span class="o">=</span><span class="bp">None</span><span class="p">):</span>

        <span class="n">choices</span> <span class="o">=</span> <span class="p">[(</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">_</span><span class="p">(</span><span class="sa">u</span><span class="s1">&#39;Todos los tipos&#39;</span><span class="p">))]</span>
        <span class="n">choices</span> <span class="o">+=</span> <span class="p">[(</span><span class="s1">&#39;{0}___{1}&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">it</span><span class="o">.</span><span class="n">group_id</span><span class="p">,</span> <span class="n">it</span><span class="o">.</span><span class="n">pk</span><span class="p">),</span> <span class="n">it</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="k">for</span> <span class="n">it</span> <span class="ow">in</span> <span class="n">ProductType</span><span class="o">.</span><span class="n">objects</span><span class="o">.</span><span class="n">order_by</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">base_filters</span><span class="p">[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">field</span><span class="o">.</span><span class="n">widget</span> <span class="o">=</span> <span class="n">CustomSelect</span><span class="p">(</span><span class="n">choices</span><span class="o">=</span><span class="n">choices</span><span class="p">)</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">queryset</span><span class="p">,</span> <span class="n">prefix</span><span class="p">,</span> <span class="n">strict</span><span class="p">)</span>
</pre></div>


<p>Per gestionar l'event del canvi hem de modificar el template que renderitza el formulari. D'aquesta manera incloem el Javascript necessari, el codi del propi plugin i el codi que s'encarrega de relacionar els dos selectors. </p>
<div class="highlight"><pre><span></span><span class="cp">{%</span> <span class="k">block</span> <span class="nv">extrajs2</span> <span class="cp">%}</span>
    <span class="nt">&lt;script</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span> <span class="na">src=</span><span class="s">&quot;</span><span class="cp">{%</span> <span class="k">static</span> <span class="s1">&#39;bower_components/chained/jquery.chained.min.js&#39;</span> <span class="cp">%}</span><span class="s">&quot;</span><span class="nt">&gt;&lt;/script&gt;</span>
    <span class="nt">&lt;script</span> <span class="na">type=</span><span class="s">&quot;text/javascript&quot;</span><span class="nt">&gt;</span>
        $(function(){
            $(&quot;#id_type&quot;).chained(&quot;#id_group&quot;);
        });
    <span class="nt">&lt;/script&gt;</span>
<span class="cp">{%</span> <span class="k">endblock</span> <span class="nv">extrajs2</span> <span class="cp">%}</span>
</pre></div>


<p>A l'exemple li deim que el selector amb identificador "#id_type" depen del selector amb identificador "#id_group". Finalment senyalar que el plugin és bastant versàtil ja que permet enllaçar varis selectors a la vegada amb la mateixa tècnica. </p>
<p><a href="http://www.appelsiini.net/projects/chained">http://www.appelsiini.net/projects/chained</a></p>                </article>
            </aside><!-- /#featured -->
        <section id="extras" class="body">
                <div class="blogroll">
                        <h2>links</h2>
                        <ul>
                            <li><a href="http://getpelican.com/">Pelican</a></li>
                            <li><a href="http://python.org/">Python.org</a></li>
                            <li><a href="http://jinja.pocoo.org/">Jinja2</a></li>
                        </ul>
                </div><!-- /.blogroll -->
                <div class="social">
                        <h2>social</h2>
                        <ul>
                            <li><a href="https:/www.espontas.com/feeds/all.atom.xml" type="application/atom+xml" rel="alternate">atom feed</a></li>

                            <li><a href="https://github.com/avallbona">github</a></li>
                            <li><a href="https://twitter.com/avallbona">twitter</a></li>
                        </ul>
                </div><!-- /.social -->
        </section><!-- /#extras -->

        <footer id="contentinfo" class="body">
                <address id="about" class="vcard body">
                Proudly powered by <a href="http://getpelican.com/">Pelican</a>, which takes great advantage of <a href="http://python.org">Python</a>.
                </address><!-- /#about -->

                <p>The theme is by <a href="http://coding.smashingmagazine.com/2009/08/04/designing-a-html-5-layout-from-scratch/">Smashing Magazine</a>, thanks!</p>
        </footer><!-- /#contentinfo -->

</body>
</html>